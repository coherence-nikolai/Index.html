<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coherence</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%2378f0b1'/></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#0d1117">

  <style>
    :root {
      --bg: #0d1117;
      --surface: #131920;
      --surface2: #1a2332;
      --border: rgba(255,255,255,.07);
      --border-hover: rgba(255,255,255,.15);
      --text: #e8edf3;
      --text-dim: #6b7c94;
      --text-muted: #3d4f63;
      --accent: #78f0b1;
      --accent-dim: rgba(120,240,177,.12);
      --accent-glow: rgba(120,240,177,.3);
      --font-display: 'DM Serif Display', Georgia, serif;
      --font-body: 'DM Sans', system-ui, sans-serif;
      --r: 20px;
      --r-sm: 12px;
    }
    .light {
      --bg: #f0f4f8;
      --surface: #ffffff;
      --surface2: #e8eef5;
      --border: rgba(0,0,0,.07);
      --border-hover: rgba(0,0,0,.15);
      --text: #0d1117;
      --text-dim: #4a5e72;
      --text-muted: #a0b4c8;
      --accent: #1a9e6c;
      --accent-dim: rgba(26,158,108,.1);
      --accent-glow: rgba(26,158,108,.25);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 15px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    body::before {
      content: '';
      position: fixed;
      top: -30%;
      left: 50%;
      transform: translateX(-50%);
      width: 80vw;
      height: 60vw;
      background: radial-gradient(ellipse, rgba(120,240,177,.04) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    .page {
      position: relative;
      z-index: 1;
      max-width: 520px;
      margin: 0 auto;
      padding: 28px 18px 70px;
    }

    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 22px;
      gap: 12px;
    }
    .logo {
      font-family: var(--font-display);
      font-size: 36px;
      letter-spacing: -.5px;
      color: var(--text);
    }
    .logo em { font-style: italic; color: var(--accent); }
    .tagline {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .theme-toggle {
      background: none;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      font-family: var(--font-body);
      color: var(--text-dim);
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }
    .theme-toggle:hover { border-color: var(--border-hover); color: var(--text); }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 22px;
      margin-bottom: 12px;
    }
    .card-title {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    .breath-card {
      text-align: center;
      padding: 28px 20px;
      overflow: hidden;
      position: relative;
    }

    .circle-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
    }
    .circle-ring {
      position: absolute;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      border: 1px solid var(--accent-dim);
      animation: ring-pulse 4s ease-in-out infinite;
    }
    .circle-ring:nth-child(2) {
      width: 200px; height: 200px;
      border-color: rgba(120,240,177,.06);
      animation-delay: .5s;
    }
    @keyframes ring-pulse {
      0%, 100% { transform: scale(1); opacity: .5; }
      50% { transform: scale(1.04); opacity: 1; }
    }

    .circle {
      position: relative;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 30%,
        rgba(255,255,255,.2) 0%,
        rgba(255,255,255,.0) 50%),
        var(--c, #78f0b1);
      box-shadow:
        0 0 60px var(--cg, rgba(120,240,177,.25)),
        inset 0 1px 0 rgba(255,255,255,.3);
      transition:
        transform 800ms cubic-bezier(.4,0,.2,1),
        filter 600ms ease,
        --c 400ms ease,
        --cg 400ms ease;
      cursor: pointer;
      user-select: none;
      z-index: 1;
    }
    .circle.inhale  { transform: scale(1.15); filter: brightness(1.1); }
    .circle.hold    { transform: scale(1.15); filter: brightness(1.05) saturate(1.2); }
    .circle.exhale  { transform: scale(.85);  filter: brightness(.95); }
    .circle.idle    { transform: scale(1);    filter: brightness(1); }

    .phase-label {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: var(--font-body);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: rgba(10,20,15,.7);
      pointer-events: none;
    }
    .phase-countdown {
      font-family: var(--font-display);
      font-size: 26px;
      letter-spacing: -.5px;
      color: rgba(10,20,15,.82);
      line-height: 1;
      margin-bottom: 2px;
    }

    .status-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--surface2);
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 700;
      color: var(--text-dim);
    }
    .pill.active {
      background: var(--accent-dim);
      border-color: rgba(120,240,177,.2);
      color: var(--accent);
    }
    .pill .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: currentColor;
    }

    .btn-start {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--accent);
      color: #0a180f;
      border: none;
      border-radius: 999px;
      padding: 12px 30px;
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 800;
      cursor: pointer;
      transition: all .2s;
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .btn-start:hover { transform: translateY(-1px); box-shadow: 0 6px 24px var(--accent-glow); }
    .btn-start:active { transform: translateY(0); }
    .btn-start.running {
      background: var(--surface2);
      color: var(--text-dim);
      box-shadow: none;
    }

    .what-banner {
      background: var(--accent-dim);
      border: 1px solid rgba(120,240,177,.12);
      border-radius: var(--r-sm);
      padding: 10px 14px;
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.5;
      margin-top: 14px;
      text-align: left;
    }
    .what-banner strong { color: var(--text); font-weight: 700; }

    .select-wrap { position: relative; }
    .select-wrap::after {
      content: '‚ñæ';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--text-dim);
      font-size: 12px;
    }
    select {
      width: 100%;
      appearance: none;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 10px 36px 10px 14px;
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
      transition: border-color .2s;
    }
    select:hover, select:focus { border-color: var(--border-hover); outline: none; }

    /* Improved timing/duration area (no tall empty stacks) */
    .timing-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 430px) {
      .timing-grid { grid-template-columns: 1fr 1fr; }
    }
    .timing-field label {
      display: block;
      font-size: 10px;
      font-weight: 800;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .timing-field input {
      width: 100%;
      height: 44px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 8px 10px;
      font-family: var(--font-body);
      font-size: 18px;
      font-weight: 800;
      text-align: center;
      color: var(--text);
      transition: border-color .2s;
    }
    .timing-field input:focus { outline: none; border-color: var(--accent); }

    .dur-row {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .dur-chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip {
      padding: 7px 14px;
      border-radius: 999px;
      background: var(--surface2);
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 900;
      color: var(--text-dim);
      cursor: pointer;
      transition: all .15s;
    }
    .chip:hover { border-color: var(--border-hover); color: var(--text); }
    .chip.active {
      background: var(--accent-dim);
      border-color: rgba(120,240,177,.25);
      color: var(--accent);
    }
    .range-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .range-row span { font-size: 11px; color: var(--text-muted); font-weight: 800; min-width: 34px; }
    input[type=range] { flex: 1; accent-color: var(--accent); cursor: pointer; }
    .dur-badge {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 900;
      color: var(--text);
      min-width: 52px;
      text-align: center;
    }

    .cue-display {
      font-family: var(--font-display);
      font-size: 28px;
      line-height: 1.2;
      color: var(--text);
      margin: 10px 0 14px;
      min-height: 36px;
      transition: opacity .3s;
    }
    .cue-display.fade { opacity: 0; }

    .stream-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .stream-row .select-wrap { flex: 1; min-width: 140px; }
    input[type=text].custom-stream {
      flex: 1;
      min-width: 140px;
      height: 44px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 10px 14px;
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--text);
      transition: border-color .2s;
    }
    input[type=text].custom-stream:focus { outline: none; border-color: var(--accent); }

    .btn-ghost {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 10px 14px;
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 800;
      color: var(--text-dim);
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }
    .btn-ghost:hover { border-color: var(--border-hover); color: var(--text); }

    hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

    .field-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .field-count {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
      font-size: 12px;
      color: var(--text-dim);
      font-weight: 800;
    }
    .field-dot {
      width: 9px; height: 9px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: background .3s;
    }
    .field-dot.online { background: var(--accent); box-shadow: 0 0 6px var(--accent-glow); }
    #fieldStatus { font-size: 12px; color: var(--text-dim); font-weight: 700; }

    .toggle-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text-dim);
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    .toggle.active {
      border-color: rgba(120,240,177,.25);
      background: var(--accent-dim);
      color: var(--accent);
    }

    .gauge-wrap { display: flex; align-items: center; gap: 12px; }
    .gauge-value {
      font-family: var(--font-display);
      font-size: 28px;
      color: var(--text);
      min-width: 34px;
      text-align: center;
      line-height: 1;
    }
    .gauge-word {
      font-size: 11px;
      color: var(--text-dim);
      text-align: center;
      font-weight: 800;
      letter-spacing: .05em;
      min-width: 62px;
    }
    .gauge-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      margin-top: 4px;
    }

    textarea {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 12px 14px;
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--text);
      resize: vertical;
      transition: border-color .2s;
      min-height: 80px;
    }
    textarea:focus { outline: none; border-color: var(--accent); }
    textarea::placeholder { color: var(--text-muted); }

    .log-actions { display: flex; gap: 8px; margin-top: 10px; }
    .btn-log {
      background: var(--accent);
      color: #0a180f;
      border: none;
      border-radius: var(--r-sm);
      padding: 10px 22px;
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 900;
      cursor: pointer;
      transition: all .2s;
    }
    .btn-log:hover { filter: brightness(1.05); }

    .log-entries { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; }
    .log-entry {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 12px 14px;
      animation: slide-in .3s ease;
    }
    @keyframes slide-in {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .log-ts {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 800;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .log-cue { font-weight: 900; font-size: 14px; color: var(--text); }
    .log-gauge {
      display: inline-block;
      margin-left: 6px;
      font-size: 11px;
      color: var(--accent);
      font-weight: 900;
      background: var(--accent-dim);
      border-radius: 999px;
      padding: 1px 8px;
    }
    .log-note {
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-dim);
      white-space: pre-wrap;
    }
    .empty-state { text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

<div class="page">

  <header class="header">
    <div>
      <h1 class="logo">Co<em>here</em>nce</h1>
      <div class="tagline">Reset ¬∑ Steer ¬∑ Reflect</div>
    </div>
    <button class="theme-toggle" id="themeBtn">‚òÄ Light</button>
  </header>

  <div class="card breath-card">
    <div class="circle-wrap">
      <div class="circle-ring"></div>
      <div class="circle-ring"></div>
      <div class="circle" id="circle">
        <div class="phase-label">
          <span class="phase-countdown" id="phaseCountdown">¬∑</span>
          <span id="phaseText">Tap circle to change colour</span>
        </div>
      </div>
    </div>

    <div class="status-row">
      <div class="pill" id="phasePill"><span class="dot"></span> Ready</div>
      <div class="pill" id="timerPill">00:00</div>
      <div class="pill" id="fieldPill">Field: ‚Äî</div>
    </div>

    <button class="btn-start" id="startBtn">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
        <path d="M3 2l9 5-9 5V2z"/>
      </svg>
      Start
    </button>

    <div class="what-banner" id="whatBanner">
      <strong>What this does:</strong> ‚Äî
    </div>
  </div>

  <div class="card">
    <div class="card-title">Breath Pattern</div>

    <div class="select-wrap">
      <select id="preset"></select>
    </div>

    <div class="timing-grid">
      <div class="timing-field">
        <label for="inSec">In</label>
        <input id="inSec" type="number" value="4" min="1" inputmode="numeric">
      </div>
      <div class="timing-field">
        <label for="holdSec">Hold</label>
        <input id="holdSec" type="number" value="0" min="0" inputmode="numeric">
      </div>
      <div class="timing-field">
        <label for="outSec">Out</label>
        <input id="outSec" type="number" value="6" min="1" inputmode="numeric">
      </div>
    </div>

    <div class="dur-row">
      <div class="dur-chips" id="durationChips">
        <button class="chip" data-min="1">1m</button>
        <button class="chip" data-min="2">2m</button>
        <button class="chip" data-min="3">3m</button>
        <button class="chip" data-min="5">5m</button>
        <button class="chip" data-min="10">10m</button>
        <button class="chip" data-min="15">15m</button>
      </div>

      <div class="range-row">
        <span>Time</span>
        <input type="range" id="durationSlider" min="1" max="20" value="1">
        <div class="dur-badge" id="durBadge">1m</div>
      </div>

      <div class="timing-field" style="max-width:160px;">
        <label for="durationMin">Minutes</label>
        <input id="durationMin" type="number" value="1" min="1" max="60" inputmode="numeric">
      </div>
    </div>

    <div class="toggle-row">
      <div class="toggle" id="bellToggle">üîî Bell</div>
      <div class="toggle" id="wakeToggle">üåô Keep awake</div>
      <div class="toggle" id="promptToggle">üìù End prompt</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Intention Stream</div>
    <div class="cue-display" id="cueLine">Equanimity and awareness</div>

    <div class="stream-row">
      <div class="select-wrap">
        <select id="stream">
          <option>Gentle</option>
          <option>Equanimity</option>
          <option>Joy</option>
          <option>Reverence</option>
          <option>Metta</option>
          <option>Radiance</option>
          <option>Custom</option>
        </select>
      </div>
      <input type="text" class="custom-stream" id="customStream" placeholder="Custom label">
      <button class="btn-ghost" id="newCueBtn">New cue</button>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Shared Field</div>
    <div class="field-row">
      <button class="btn-ghost" id="joinBtn">Join</button>
      <button class="btn-ghost" id="leaveBtn">Leave</button>
      <span id="fieldStatus">Not joined</span>
      <div class="field-count">
        <div class="field-dot" id="fieldDot"></div>
        <span id="countPill">0</span> here
      </div>
    </div>
    <div style="margin-top:10px; font-size:12px; color:var(--text-muted);">
      This count is lightweight presence (not chat). It stays accurate via a small heartbeat while you‚Äôre joined.
    </div>
  </div>

  <div class="card">
    <div class="card-title">Reflect</div>

    <div class="gauge-wrap">
      <div>
        <div class="gauge-value" id="gaugeVal">0</div>
        <div class="gauge-word" id="gaugeWord">Neutral</div>
      </div>
      <div style="flex:1">
        <input type="range" id="gauge" min="-5" max="5" value="0" style="width:100%">
        <div class="gauge-labels"><span>Tight</span><span>Open</span></div>
      </div>
    </div>

    <hr>

    <textarea id="note" rows="3" placeholder="One line note‚Ä¶"></textarea>

    <div class="log-actions">
      <button class="btn-log" id="logBtn">Log Entry</button>
      <button class="btn-ghost" id="clearBtn">Clear All</button>
    </div>

    <div class="log-entries" id="logEntries">
      <div class="empty-state">No entries yet. Start breathing and log how you feel.</div>
    </div>
  </div>

</div>

<script>
(() => {
  'use strict';

  /* CONFIG */
  const WORKER_BASE   = 'https://coherence-presence-2.lucolly999.workers.dev';
  const KEY_LOGS      = 'coh_logs_v4';
  const KEY_THEME     = 'coh_theme_v4';
  const KEY_COLOR     = 'coh_color_v4';
  const KEY_CLIENT    = 'coh_client_id_v4';
  const KEY_FIELD_ON  = 'coh_field_joined_v4';
  const KEY_BELL      = 'coh_bell_v4';
  const KEY_WAKE      = 'coh_wake_v4';
  const KEY_PROMPT    = 'coh_prompt_v4';

  /* CIRCLE PALETTES */
  const PALETTES = [
    { c: '#78f0b1', g: 'rgba(120,240,177,.3)' },  // mint
    { c: '#7ab8ff', g: 'rgba(122,184,255,.3)' },  // sky
    { c: '#ffd36b', g: 'rgba(255,211,107,.3)' },  // sun
    { c: '#ff8ec5', g: 'rgba(255,142,197,.3)' },  // rose
    { c: '#b493ff', g: 'rgba(180,147,255,.3)' },  // violet
    { c: '#9ff0ff', g: 'rgba(159,240,255,.3)' },  // aqua
    { c: '#c6ff7a', g: 'rgba(198,255,122,.3)' },  // lime
  ];

  /* PRESETS + short user explanation */
  const PRESETS = [
    { name: 'Calm (4‚Äì0‚Äì6)',      in:4, hold:0, out:6, msg:'Longer exhale signals safety and supports vagal tone (parasympathetic settling).' },
    { name: 'Focus (4‚Äì0‚Äì4)',     in:4, hold:0, out:4, msg:'Balanced breathing supports steady attention without pushing the nervous system.' },
    { name: 'Downshift (3‚Äì0‚Äì6)', in:3, hold:0, out:6, msg:'Short in + long out eases urgency and reduces activation gently.' },
    { name: 'Ground (4‚Äì2‚Äì6)',    in:4, hold:2, out:6, msg:'A brief hold can sharpen interoception; long exhale helps the body land.' },
    { name: 'Sleep (4‚Äì7‚Äì8)',     in:4, hold:7, out:8, msg:'Extended hold + long exhale encourages heaviness and sleepiness.' },
    { name: 'Reset (2‚Äì0‚Äì6)',     in:2, hold:0, out:6, msg:'Light inhale, long exhale. Pair with soft jaw + dropped shoulders.' },
    { name: 'Custom',            in:4, hold:0, out:6, msg:'Custom rhythm. Anxious? lengthen exhale. Flat? shorten exhale a little.' },
  ];

  /* CUES */
  const CUES = [
    'Equanimity and awareness','Steady','Match this breath','Soft eyes, soft jaw','Release',
    'Tone first','Gentle return','Reverence','Joy, unearned','Metta','Nothing to fix',
    'Ground here','Let the exhale land','Presence before response'
  ];

  /* DOM */
  const el = (id) => document.getElementById(id);
  const circle         = el('circle');
  const phaseText      = el('phaseText');
  const phaseCountdown = el('phaseCountdown');
  const phasePill      = el('phasePill');
  const timerPill      = el('timerPill');
  const fieldPill      = el('fieldPill');
  const startBtn       = el('startBtn');
  const whatBanner     = el('whatBanner');
  const presetSel      = el('preset');
  const inSec          = el('inSec');
  const holdSec        = el('holdSec');
  const outSec         = el('outSec');
  const durationMin    = el('durationMin');
  const durationSlider = el('durationSlider');
  const durBadge       = el('durBadge');
  const chips          = Array.from(el('durationChips').querySelectorAll('.chip'));
  const streamSel      = el('stream');
  const customStream   = el('customStream');
  const cueLine        = el('cueLine');
  const newCueBtn      = el('newCueBtn');
  const joinBtn        = el('joinBtn');
  const leaveBtn       = el('leaveBtn');
  const fieldStatus    = el('fieldStatus');
  const fieldDot       = el('fieldDot');
  const countPill      = el('countPill');
  const gauge          = el('gauge');
  const gaugeVal       = el('gaugeVal');
  const gaugeWord      = el('gaugeWord');
  const note           = el('note');
  const logBtn         = el('logBtn');
  const clearBtn       = el('clearBtn');
  const logEntries     = el('logEntries');
  const themeBtn       = el('themeBtn');

  const bellToggle     = el('bellToggle');
  const wakeToggle     = el('wakeToggle');
  const promptToggle   = el('promptToggle');

  /* STATE */
  let running = false;
  let phase = 'idle';          // idle | in | hold | out
  let phaseRemaining = 0;
  let totalRemaining = 0;
  let tick = null;
  let paletteIdx = 0;

  // field
  let joined = false;
  let heartbeatTimer = null;
  let countTimer = null;

  // wake lock
  let wakeLock = null;

  /* HAPTIC */
  function haptic(ms = 10) {
    try { navigator.vibrate && navigator.vibrate(ms); } catch(e) {}
  }

  /* SAFE HTML */
  function esc(s) {
    return (s || '').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
  }

  /* THEME */
  function applyTheme(light) {
    document.body.classList.toggle('light', light);
    localStorage.setItem(KEY_THEME, light ? 'light' : 'dark');
    themeBtn.textContent = light ? '‚òΩ Dark' : '‚òÄ Light';
  }
  themeBtn.addEventListener('click', () => {
    applyTheme(!document.body.classList.contains('light'));
    haptic(8);
  });

  /* CIRCLE COLOR */
  function applyPalette(idx) {
    const p = PALETTES[idx];
    circle.style.setProperty('--c', p.c);
    circle.style.setProperty('--cg', p.g);
    localStorage.setItem(KEY_COLOR, String(idx));
  }
  circle.addEventListener('click', () => {
    if (running) return;
    paletteIdx = (paletteIdx + 1) % PALETTES.length;
    applyPalette(paletteIdx);
    haptic(8);
  });

  /* PRESETS */
  function buildPresets() {
    PRESETS.forEach((p, i) => {
      const o = document.createElement('option');
      o.value = i;
      o.textContent = p.name;
      presetSel.appendChild(o);
    });
  }
  function applyPreset(idx) {
    const p = PRESETS[idx];
    inSec.value = p.in;
    holdSec.value = p.hold;
    outSec.value = p.out;
    whatBanner.innerHTML = `<strong>What this does:</strong> ${esc(p.msg)}`;
  }
  presetSel.addEventListener('change', () => {
    applyPreset(+presetSel.value);
    haptic(8);
  });

  /* DURATION (chips + slider + minutes box) */
  function setDuration(min) {
    const m = Math.max(1, Math.min(60, parseInt(min || 1, 10)));
    durationMin.value = m;
    durationSlider.value = String(Math.min(20, m));
    durBadge.textContent = m + 'm';
    chips.forEach(c => c.classList.toggle('active', +c.dataset.min === m));
  }
  chips.forEach(c => c.addEventListener('click', () => { setDuration(c.dataset.min); haptic(6); }));
  durationSlider.addEventListener('input', () => setDuration(durationSlider.value));
  durationMin.addEventListener('input', () => setDuration(durationMin.value));

  /* STREAM / CUSTOM */
  function getStreamLabel() {
    const s = streamSel.value;
    if (s === 'Custom') return (customStream.value || 'Custom').trim();
    return s;
  }
  streamSel.addEventListener('change', () => {
    if (streamSel.value !== 'Custom') customStream.value = '';
  });

  /* CUES */
  function randomCue() {
    const current = cueLine.textContent;
    const options = CUES.filter(c => c !== current);
    return options[Math.floor(Math.random() * options.length)];
  }
  newCueBtn.addEventListener('click', () => {
    cueLine.classList.add('fade');
    setTimeout(() => {
      cueLine.textContent = randomCue();
      cueLine.classList.remove('fade');
    }, 140);
    haptic(6);
  });

  /* GAUGE */
  function gaugeLabel(v) {
    if (v <= -3) return 'Tight';
    if (v >= 3) return 'Open';
    return 'Neutral';
  }
  gauge.addEventListener('input', () => {
    const v = +gauge.value;
    gaugeVal.textContent = v > 0 ? '+' + v : String(v);
    gaugeWord.textContent = gaugeLabel(v);
  });

  /* AUDIO BELL (simple, optional) */
  function bell(f = 523.25, durMs = 140) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = f;
      g.gain.value = 0.0001;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      const t0 = ctx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.08, t0 + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + durMs/1000);
      o.stop(t0 + durMs/1000 + 0.02);
      setTimeout(() => ctx.close(), durMs + 120);
    } catch(e) {}
  }

  /* TOGGLES (extras) */
  function setToggle(elm, key, on) {
    elm.classList.toggle('active', !!on);
    localStorage.setItem(key, on ? '1' : '0');
  }
  function getToggle(key) { return localStorage.getItem(key) === '1'; }

  bellToggle.addEventListener('click', () => { setToggle(bellToggle, KEY_BELL, !getToggle(KEY_BELL)); haptic(8); });
  wakeToggle.addEventListener('click', async () => {
    const next = !getToggle(KEY_WAKE);
    setToggle(wakeToggle, KEY_WAKE, next);
    if (next && running) await requestWake();
    if (!next) await releaseWake();
    haptic(8);
  });
  promptToggle.addEventListener('click', () => { setToggle(promptToggle, KEY_PROMPT, !getToggle(KEY_PROMPT)); haptic(8); });

  async function requestWake() {
    try {
      if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
    } catch(e) {}
  }
  async function releaseWake() {
    try { if (wakeLock) { await wakeLock.release(); wakeLock = null; } } catch(e) {}
  }

  /* BREATH ENGINE */
  function getTimings() {
    const i = Math.max(1, parseInt(inSec.value || 1, 10));
    const h = Math.max(0, parseInt(holdSec.value || 0, 10));
    const o = Math.max(1, parseInt(outSec.value || 1, 10));
    return { in:i, hold:h, out:o };
  }
  function mmss(s) {
    s = Math.max(0, Math.floor(s));
    return String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
  }
  function setPhase(p, dur) {
    phase = p;
    phaseRemaining = dur;

    circle.classList.remove('inhale','hold','exhale','idle');
    if (p === 'in') circle.classList.add('inhale');
    if (p === 'hold') circle.classList.add('hold');
    if (p === 'out') circle.classList.add('exhale');

    const labels = { in:'Inhale', hold:'Hold', out:'Exhale', idle:'Ready' };
    phasePill.innerHTML = `<span class="dot"></span> ${labels[p] || 'Ready'}`;
    phasePill.classList.toggle('active', p !== 'idle');
    phaseText.textContent = labels[p] || 'Tap circle to change colour';
    phaseCountdown.textContent = phaseRemaining > 0 ? String(phaseRemaining) : '¬∑';

    // gentle haptic at phase transition
    haptic(10);
  }
  function advancePhase() {
    const t = getTimings();
    if (phase === 'idle' || phase === 'out') {
      setPhase('in', t.in);
    } else if (phase === 'in') {
      (t.hold > 0) ? setPhase('hold', t.hold) : setPhase('out', t.out);
    } else if (phase === 'hold') {
      setPhase('out', t.out);
    }
  }
  async function startBreath() {
    const m = Math.max(1, parseInt(durationMin.value || 1, 10));
    totalRemaining = m * 60;

    running = true;
    startBtn.classList.add('running');
    startBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><rect x="3" y="3" width="8" height="8" rx="1"/></svg> Stop`;

    if (getToggle(KEY_WAKE)) await requestWake();
    if (getToggle(KEY_BELL)) bell(659.25, 120); // start bell

    advancePhase();

    tick = setInterval(async () => {
      totalRemaining -= 1;
      timerPill.textContent = mmss(totalRemaining);

      phaseRemaining -= 1;
      phaseCountdown.textContent = phaseRemaining > 0 ? String(phaseRemaining) : '';

      if (phaseRemaining <= 0) advancePhase();

      if (totalRemaining <= 0) {
        stopBreath(true);
      }
    }, 1000);
  }
  function stopBreath(endedNaturally = false) {
    running = false;
    if (tick) { clearInterval(tick); tick = null; }

    phase = 'idle';
    circle.classList.remove('inhale','hold','exhale');
    circle.classList.add('idle');
    setTimeout(() => circle.classList.remove('idle'), 800);

    phasePill.innerHTML = '<span class="dot"></span> Ready';
    phasePill.classList.remove('active');
    phaseText.textContent = 'Tap circle to change colour';
    phaseCountdown.textContent = '¬∑';
    timerPill.textContent = '00:00';

    startBtn.classList.remove('running');
    startBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><path d="M3 2l9 5-9 5V2z"/></svg> Start`;

    releaseWake();

    if (endedNaturally) {
      haptic(40);
      if (getToggle(KEY_BELL)) bell(523.25, 170); // end bell
      if (getToggle(KEY_PROMPT)) {
        setTimeout(() => {
          if (confirm("Session complete. Log how you feel?")) {
            note.focus();
          }
        }, 120);
      }
    }
  }
  startBtn.addEventListener('click', () => {
    running ? stopBreath(false) : startBreath();
    haptic(12);
  });

  /* LOGS */
  function loadLogs() {
    try { return JSON.parse(localStorage.getItem(KEY_LOGS) || '[]'); }
    catch(e) { return []; }
  }
  function saveLogs(logs) { localStorage.setItem(KEY_LOGS, JSON.stringify(logs)); }
  function renderLogs() {
    const logs = loadLogs().slice().reverse();
    if (!logs.length) {
      logEntries.innerHTML = '<div class="empty-state">No entries yet. Start breathing and log how you feel.</div>';
      return;
    }
    logEntries.innerHTML = logs.map(item => {
      const safeCue  = esc(item.cue || '');
      const safeNote = esc(item.note || '');
      const gv = +item.gauge;
      const gDisplay = gv > 0 ? '+' + gv : String(gv);
      return `
        <div class="log-entry">
          <div class="log-ts">${new Date(item.ts).toLocaleString()}</div>
          <div class="log-cue">${safeCue}<span class="log-gauge">${gDisplay} ¬∑ ${gaugeLabel(gv)}</span></div>
          ${safeNote ? `<div class="log-note">${safeNote}</div>` : ''}
        </div>`;
    }).join('');
  }
  logBtn.addEventListener('click', () => {
    const logs = loadLogs();
    logs.push({
      ts: new Date().toISOString(),
      cue: cueLine.textContent,
      gauge: +gauge.value,
      note: note.value.trim()
    });
    saveLogs(logs);
    note.value = '';
    renderLogs();
    haptic(8);
  });
  clearBtn.addEventListener('click', () => {
    if (!confirm('Clear all log entries?')) return;
    localStorage.removeItem(KEY_LOGS);
    renderLogs();
  });

  /* SHARED FIELD (stable client id + heartbeat) */
  function getClientId() {
    let id = localStorage.getItem(KEY_CLIENT);
    if (!id) {
      id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + '-' + Math.random().toString(16).slice(2);
      localStorage.setItem(KEY_CLIENT, id);
    }
    return id;
  }
  async function api(path) {
    const res = await fetch(WORKER_BASE + path, { cache: 'no-store' });
    return res.json();
  }
  async function refreshCount() {
    try {
      const r = await api('/count');
      if (r?.count != null) countPill.textContent = r.count;
    } catch(e) {}
  }
  function setFieldUI(on) {
    joined = !!on;
    fieldStatus.textContent = on ? 'Joined' : 'Not joined';
    fieldDot.classList.toggle('online', on);
    fieldPill.textContent = 'Field: ' + (on ? 'joined' : '‚Äî');
    localStorage.setItem(KEY_FIELD_ON, on ? '1' : '0');
  }
  async function heartbeatOnce() {
    if (!joined) return;
    const id = getClientId();
    try {
      const r = await api('/heartbeat?id=' + encodeURIComponent(id));
      if (r?.ok) {
        countPill.textContent = r.count ?? countPill.textContent;
      }
    } catch(e) {}
  }
  async function joinField() {
    const id = getClientId();
    try {
      const r = await api('/join?id=' + encodeURIComponent(id));
      if (r?.ok) {
        setFieldUI(true);
        countPill.textContent = r.count ?? 0;
        haptic([12,8,12]);
        if (!heartbeatTimer) heartbeatTimer = setInterval(heartbeatOnce, 20000);
      } else {
        fieldStatus.textContent = 'Error';
      }
    } catch(e) {
      fieldStatus.textContent = 'Error';
    }
  }
  async function leaveField() {
    const id = localStorage.getItem(KEY_CLIENT);
    if (!id) {
      // if missing, just update UI
      setFieldUI(false);
      await refreshCount();
      return;
    }
    try {
      const r = await api('/leave?id=' + encodeURIComponent(id));
      setFieldUI(false);
      countPill.textContent = r?.count ?? countPill.textContent;
      haptic(8);
    } catch(e) {
      setFieldUI(false);
    }
    if (heartbeatTimer) { clearInterval(heartbeatTimer); heartbeatTimer = null; }
  }
  joinBtn.addEventListener('click', joinField);
  leaveBtn.addEventListener('click', leaveField);

  /* INIT */
  function init() {
    // theme
    const savedTheme = localStorage.getItem(KEY_THEME);
    applyTheme(savedTheme === 'light');

    // toggles
    setToggle(bellToggle, KEY_BELL, getToggle(KEY_BELL));
    setToggle(wakeToggle, KEY_WAKE, getToggle(KEY_WAKE));
    setToggle(promptToggle, KEY_PROMPT, getToggle(KEY_PROMPT));

    // palette
    const savedColor = parseInt(localStorage.getItem(KEY_COLOR) || '0', 10);
    paletteIdx = (isFinite(savedColor) ? savedColor : 0) % PALETTES.length;
    applyPalette(paletteIdx);

    // presets
    buildPresets();
    presetSel.value = "0";
    applyPreset(0);

    // duration
    setDuration(1);

    // gauge
    gauge.dispatchEvent(new Event('input'));

    // logs
    renderLogs();

    // field
    const wasJoined = localStorage.getItem(KEY_FIELD_ON) === '1';
    setFieldUI(wasJoined);
    refreshCount();
    if (!countTimer) countTimer = setInterval(refreshCount, 5000);
    if (wasJoined && !heartbeatTimer) heartbeatTimer = setInterval(heartbeatOnce, 20000);
    if (wasJoined) heartbeatOnce();
  }

  init();
})();
</script>
</body>
</html>
