<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Coherence</title>
  <meta name="theme-color" content="#080f12">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%2378f0b1'/></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
  <style>
  :root {
    --bg:#080f12; --bg2:#0c1419; --surface:#111c24; --surface2:#182530; --surface3:#1f3040;
    --border:rgba(255,255,255,.06); --border-h:rgba(255,255,255,.13);
    --text:#dde8f0; --text-dim:#607587; --text-muted:#334455;
    --accent:#78f0b1; --accent-dim:rgba(120,240,177,.1); --accent-glow:rgba(120,240,177,.28);
    --font-d:'DM Serif Display', Georgia, serif; --font-b:'DM Sans', system-ui, sans-serif;
    --r:18px; --r-sm:11px; --transition:.22s cubic-bezier(.4,0,.2,1);
  }
  .light {
    --bg:#eef3f8; --bg2:#e4ecf3; --surface:#ffffff; --surface2:#eaf0f7; --surface3:#dde8f2;
    --border:rgba(0,0,0,.07); --border-h:rgba(0,0,0,.14);
    --text:#0d1a24; --text-dim:#4a6070; --text-muted:#a0b8c8;
    --accent:#1a9e6c; --accent-dim:rgba(26,158,108,.1); --accent-glow:rgba(26,158,108,.22);
  }

  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  html{scroll-behavior:smooth;}
  body{
    font-family:var(--font-b); background:var(--bg); color:var(--text);
    min-height:100vh; font-size:15px; line-height:1.5; -webkit-font-smoothing:antialiased; overflow-x:hidden;
  }
  body::before{
    content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(ellipse 80vw 60vw at 50% -10%, rgba(120,240,177,.04) 0%, transparent 70%),
      radial-gradient(ellipse 60vw 40vw at 90% 80%, rgba(122,184,255,.03) 0%, transparent 60%);
  }
  #ambientOverlay{position:fixed; inset:0; pointer-events:none; z-index:0; opacity:0; transition:opacity 3s ease, background 8s ease;}

  .page{position:relative; z-index:1; max-width:540px; margin:0 auto; padding:28px 18px 80px;}

  .header{display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:18px;}
  .header-controls{display:flex; gap:6px;}
  .btn-pill{
    background:none; border:1px solid var(--border); border-radius:999px;
    padding:5px 13px; font-size:11px; font-family:var(--font-b); color:var(--text-dim); cursor:pointer;
    transition:all var(--transition); white-space:nowrap;
  }
  .btn-pill:hover{border-color:var(--border-h); color:var(--text);}
  .btn-pill.active{background:var(--accent-dim); border-color:rgba(120,240,177,.25); color:var(--accent);}

  /* Orion: larger field header + gentle linger then fade */
  #fieldHeader{
    font-size:2.6rem; font-weight:300; letter-spacing:.08em; text-transform:lowercase;
    opacity:.8; transition:opacity 1.6s ease 0.8s; margin:0 0 10px 0;
    font-family:var(--font-d);
  }

  .card{background:var(--surface); border:1px solid var(--border); border-radius:var(--r); padding:22px; margin-bottom:10px;}
  .card-title{font-size:9px; font-weight:700; letter-spacing:.14em; text-transform:uppercase; color:var(--text-muted); margin-bottom:14px;}

  /* Breath card */
  .breath-card{text-align:center; padding:28px 22px; position:relative; overflow:hidden;}
  #waveCanvas{position:absolute; bottom:0; left:0; right:0; width:100%; height:80px; opacity:.35; pointer-events:none;}

  .circle-wrap{position:relative; display:inline-flex; align-items:center; justify-content:center; margin-bottom:18px;}
  .circle-ring{position:absolute; border-radius:50%; border:1px solid var(--accent-dim); animation:ring-pulse 5.5s ease-in-out infinite;}
  .circle-ring:nth-child(1){width:230px;height:230px;}
  .circle-ring:nth-child(2){width:210px;height:210px;border-color:rgba(120,240,177,.05);animation-delay:.7s;}
  .circle-ring:nth-child(3){width:250px;height:250px;border-color:rgba(120,240,177,.03);animation-delay:1.4s;}
  @keyframes ring-pulse{0%,100%{transform:scale(1);opacity:.4;}50%{transform:scale(1.03);opacity:.9;}}

  .circle{
    position:relative; width:164px; height:164px; border-radius:50%;
    background:radial-gradient(circle at 33% 28%, rgba(255,255,255,.22) 0%, transparent 55%), var(--c, #78f0b1);
    box-shadow:0 0 70px var(--cg, rgba(120,240,177,.25)), inset 0 1px 0 rgba(255,255,255,.3);
    transition:transform 900ms cubic-bezier(.4,0,.2,1), filter 600ms ease;
    cursor:pointer; user-select:none; z-index:1;
  }
  .circle.inhale{transform:scale(1.18); filter:brightness(1.12);}
  .circle.hold{transform:scale(1.18); filter:brightness(1.06) saturate(1.25);}
  .circle.exhale{transform:scale(.82); filter:brightness(.93);}

  .phase-label{position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:none;}
  .phase-countdown{font-family:var(--font-d); font-size:28px; letter-spacing:-.5px; color:rgba(8,20,14,.85); line-height:1;}
  .phase-text{font-size:10px; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:rgba(8,20,14,.65); margin-top:2px;}

  .status-row{display:flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap; margin-bottom:14px;}
  .pill{
    display:inline-flex; align-items:center; gap:4px; padding:5px 12px; border-radius:999px;
    background:var(--surface2); border:1px solid var(--border); font-size:11px; font-weight:600; color:var(--text-dim);
    transition:all .2s;
  }
  .pill.active{background:var(--accent-dim); border-color:rgba(120,240,177,.2); color:var(--accent);}
  .pill .dot{width:5px;height:5px;border-radius:50%; background:currentColor;}

  .btn-start{
    display:inline-flex; align-items:center; gap:8px;
    background:var(--accent); color:#0a180f; border:none; border-radius:999px;
    padding:12px 34px; font-family:var(--font-b); font-size:14px; font-weight:700;
    cursor:pointer; transition:all .2s; box-shadow:0 4px 22px var(--accent-glow);
  }
  .btn-start:hover{transform:translateY(-1px); box-shadow:0 6px 28px var(--accent-glow);}
  .btn-start.running{background:var(--surface2); color:var(--text-dim); box-shadow:none;}

  .what-banner{
    background:var(--accent-dim); border:1px solid rgba(120,240,177,.1);
    border-radius:var(--r-sm); padding:10px 14px;
    font-size:12px; color:var(--text-dim); line-height:1.55; margin-top:14px; text-align:left;
  }
  .what-banner strong{color:var(--text); font-weight:600;}

  /* Settings */
  .select-wrap{position:relative;}
  .select-wrap::after{content:'▾'; position:absolute; right:11px; top:50%; transform:translateY(-50%); pointer-events:none; color:var(--text-dim); font-size:11px;}
  select{
    width:100%; appearance:none; background:var(--surface2); border:1px solid var(--border);
    border-radius:var(--r-sm); padding:9px 34px 9px 13px;
    font-family:var(--font-b); font-size:13px; color:var(--text); cursor:pointer; transition:border-color .2s;
  }
  select:hover,select:focus{border-color:var(--border-h); outline:none;}

  .timing-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:7px; margin-top:11px;}
  @media(max-width:400px){.timing-grid{grid-template-columns:repeat(2,1fr);}}
  .timing-field label{display:block; font-size:9px; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--text-muted); margin-bottom:4px;}
  .timing-field input{
    width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:var(--r-sm);
    padding:7px; font-family:var(--font-d); font-size:22px; text-align:center; color:var(--text);
    transition:border-color .2s;
  }
  .timing-field input:focus{outline:none; border-color:var(--accent);}

  .dur-chips{display:flex; flex-wrap:wrap; gap:5px; margin-top:11px;}
  .chip{
    padding:5px 13px; border-radius:999px; background:var(--surface2); border:1px solid var(--border);
    font-size:11px; font-weight:700; color:var(--text-dim); cursor:pointer; transition:all .15s;
  }
  .chip:hover{border-color:var(--border-h); color:var(--text);}
  .chip.active{background:var(--accent-dim); border-color:rgba(120,240,177,.25); color:var(--accent);}
  .range-row{display:flex; align-items:center; gap:10px; margin-top:11px;}
  .range-row span{font-size:10px; color:var(--text-muted); font-weight:700; min-width:28px;}
  input[type=range]{flex:1; accent-color:var(--accent); cursor:pointer;}
  .dur-badge{
    background:var(--surface2); border:1px solid var(--border); border-radius:999px; padding:3px 11px;
    font-size:12px; font-weight:700; color:var(--text); min-width:38px; text-align:center;
  }

  .cue-display{
    font-family:var(--font-d); font-size:26px; line-height:1.2; color:var(--text);
    margin:10px 0 12px; min-height:34px; transition:opacity .3s;
  }
  .cue-display.fade{opacity:0;}
  .btn-ghost{
    background:var(--surface2); border:1px solid var(--border); border-radius:var(--r-sm);
    padding:8px 14px; font-family:var(--font-b); font-size:12px; font-weight:600;
    color:var(--text-dim); cursor:pointer; transition:.2s; white-space:nowrap;
  }
  .btn-ghost:hover{border-color:var(--border-h); color:var(--text);}
  
/* Orion: extra emphasis for field header */
#fieldHeader,.field-header{
  font-size:3.4rem !important;
  letter-spacing:0.12em;
  font-weight:200;
  opacity:0.9;
}

</style>
</head>
<body>
  <div id="ambientOverlay"></div>

  <div class="page">

    <div class="header">
      <div id="fieldHeader">field</div>
      <div class="header-controls">
        
        <button class="btn-pill" id="themeBtn">☀ Light</button>
      </div>
    </div>

    <div class="card breath-card">
      <canvas id="waveCanvas"></canvas>

      <div class="circle-wrap">
        <div class="circle-ring"></div>
        <div class="circle-ring"></div>
        <div class="circle-ring"></div>

        <div class="circle" id="circle">
          <div class="phase-label">
            <span class="phase-countdown" id="phaseCountdown">·</span>
            <span class="phase-text" id="phaseText">Tap to begin</span>
          </div>
        </div>
      </div>

      <div class="status-row">
        <div class="pill" id="phasePill"><span class="dot"></span> Ready</div>
        <div class="pill" id="timerPill">00:00</div>
      </div>

      <button class="btn-start" id="startBtn">
        <svg width="13" height="13" viewBox="0 0 14 14" fill="currentColor"><path d="M3 2l9 5-9 5V2z"/></svg>
        Start
      </button>

      <div class="what-banner" id="whatBanner"><strong>The field is shared.</strong> Breathe gently. Let the next breath arrive.</div>
    </div>

    <div class="card">
      <div class="card-title">Breath Pattern</div>
      <div class="select-wrap"><select id="preset"></select></div>

      <div class="timing-grid">
        <div class="timing-field">
          <label for="inSec">In</label>
          <input id="inSec" type="number" value="5.5" min="1" inputmode="decimal">
        </div>
        <div class="timing-field">
          <label for="holdSec">Hold</label>
          <input id="holdSec" type="number" value="0" min="0" inputmode="decimal">
        </div>
        <div class="timing-field">
          <label for="outSec">Out</label>
          <input id="outSec" type="number" value="5.5" min="1" inputmode="decimal">
        </div>
        <div class="timing-field">
          <label for="durationMin">Mins</label>
          <input id="durationMin" type="number" value="5" min="1" max="60" inputmode="numeric">
        </div>
      </div>

      <div class="dur-chips" id="durationChips">
        <button class="chip" data-min="2">2m</button>
        <button class="chip" data-min="5">5m</button>
        <button class="chip" data-min="10">10m</button>
        <button class="chip" data-min="15">15m</button>
        <button class="chip" data-min="20">20m</button>
      </div>

      <div class="range-row">
        <span>Dur</span>
        <input type="range" id="durationSlider" min="1" max="20" value="5">
        <div class="dur-badge" id="durBadge">5m</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Intention</div>
      <div class="cue-display" id="cueLine">Equanimity and awareness</div>
      <button class="btn-ghost" id="newCueBtn">New cue</button>
    </div>

  </div>

<script>
(() => {
'use strict';

const KEY = { theme:'coh_theme_v4', color:'coh_color_v4' };

const PALETTES = [
  { c:'#78f0b1', g:'rgba(120,240,177,.28)' },
  { c:'#7ab8ff', g:'rgba(122,184,255,.28)' },
  { c:'#ffd36b', g:'rgba(255,211,107,.28)' },
  { c:'#ff8ec5', g:'rgba(255,142,197,.28)' },
  { c:'#b493ff', g:'rgba(180,147,255,.28)' },
];

const PRESETS = [
  { name:'Coherence (5.5–0–5.5)', in:5.5, hold:0, out:5.5, msg:'A steady 5.5 breaths/min rhythm — simple, balanced, coherent.' },
  { name:'Calm (4–0–6)',          in:4,   hold:0, out:6,   msg:'Longer exhale signals safety and settles the nervous system.' },
  { name:'Equanimous (5–0–5)',    in:5,   hold:0, out:5,   msg:'Even breath — quiet attention, steady presence.' },
  { name:'Sleep (4–7–8)',         in:4,   hold:7, out:8,   msg:'A classic downshift: long exhale, longer pause, softness.' },
];

const CUES = [
  'Equanimity and awareness','Steady','Match this breath',
  'Soft eyes, soft jaw','Release','Tone first','Gentle return',
  'Reverence','Joy, unearned','Metta','Nothing to fix',
  'Ground here','Let the exhale land','Presence before response',
  'The heart knows','Open like water','No effort needed',
];

const $ = id => document.getElementById(id);

const circle = $('circle');
const phaseText = $('phaseText');
const phaseCountdown = $('phaseCountdown');
const phasePill = $('phasePill');
const timerPill = $('timerPill');
const startBtn = $('startBtn');
const presetSel = $('preset');
const inSec = $('inSec');
const holdSec = $('holdSec');
const outSec = $('outSec');
const durationMin = $('durationMin');
const durationSlider = $('durationSlider');
const durBadge = $('durBadge');
const chips = Array.from($('durationChips').querySelectorAll('.chip'));
const cueLine = $('cueLine');
const newCueBtn = $('newCueBtn');
const themeBtn = $('themeBtn');
const coherenceModeBtn = $('coherenceModeBtn');
const waveCanvas = $('waveCanvas');
const ambientOverlay = $('ambientOverlay');
const fieldHeader = $('fieldHeader');

let running = false;
let phase = 'idle';
let phaseRemaining = 0;
let totalRemaining = 0;
let tick = null;
let paletteIdx = 0;
let wavePhase = 0;
let waveAnimId = null;

let coherenceMode = false;
const resonanceRate = 5.5;

/* HAPTIC */
function haptic(ms=10){ try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){} }

/* THEME */
function applyTheme(light){
  document.body.classList.toggle('light', light);
  localStorage.setItem(KEY.theme, light ? 'light' : 'dark');
  themeBtn.textContent = light ? '☽ Dark' : '☀ Light';
}
themeBtn.addEventListener('click', () => { applyTheme(!document.body.classList.contains('light')); haptic(8); });

/* PALETTE */
function applyPalette(idx){
  const p = PALETTES[idx];
  circle.style.setProperty('--c', p.c);
  circle.style.setProperty('--cg', p.g);
  localStorage.setItem(KEY.color, String(idx));
}
circle.addEventListener('click', () => {
  if (running) return;
  paletteIdx = (paletteIdx + 1) % PALETTES.length;
  applyPalette(paletteIdx);
  haptic(8);
});

/* PRESETS */
function buildPresets(){
  PRESETS.forEach((p,i)=>{
    const o = document.createElement('option');
    o.value = i;
    o.textContent = p.name;
    presetSel.appendChild(o);
  });
}
function applyPreset(idx){
  const p = PRESETS[idx];
  inSec.value = p.in;
  holdSec.value = p.hold;
  outSec.value = p.out;
}
presetSel.addEventListener('change', () => { applyPreset(+presetSel.value); haptic(8); });

/* DURATION */
function setDuration(min){
  const m = Math.max(1, Math.min(60, +min || 1));
  durationMin.value = m;
  durationSlider.value = Math.min(20, m);
  durBadge.textContent = m + 'm';
  chips.forEach(c => c.classList.toggle('active', +c.dataset.min === m));
}
chips.forEach(c => c.addEventListener('click', () => { setDuration(c.dataset.min); haptic(6); }));
durationSlider.addEventListener('input', () => setDuration(durationSlider.value));
durationMin.addEventListener('input', () => setDuration(durationMin.value));

/* COHERENCE MODE */
coherenceModeBtn.addEventListener('click', () => {
  coherenceMode = !coherenceMode;
  coherenceModeBtn.classList.toggle('active', coherenceMode);
  if (coherenceMode){
    const secPerBreath = 60 / resonanceRate;
    const half = +(secPerBreath / 2).toFixed(1);
    inSec.value = half; holdSec.value = 0; outSec.value = half;
    presetSel.value = "0";
  }
  haptic(10);
});

/* ENGINE */
function getTimings(){
  return {
    in: Math.max(1, +inSec.value || 1),
    hold: Math.max(0, +holdSec.value || 0),
    out: Math.max(1, +outSec.value || 1),
  };
}
function mmss(s){
  s = Math.max(0, Math.floor(s));
  return String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
}
function setPhase(p, dur){
  phase = p;
  phaseRemaining = dur;
  circle.classList.remove('inhale','hold','exhale');
  if (p==='in') circle.classList.add('inhale');
  if (p==='hold') circle.classList.add('hold');
  if (p==='out') circle.classList.add('exhale');

  const labels = { in:'Inhale', hold:'Hold', out:'Exhale', idle:'Ready' };
  phasePill.innerHTML = `<span class="dot"></span> ${labels[p] || 'Ready'}`;
  phasePill.classList.toggle('active', p !== 'idle');
  phaseText.textContent = labels[p] || '';
  haptic(8);
}
function advancePhase(){
  const t = getTimings();
  if (phase==='idle' || phase==='out') setPhase('in', t.in);
  else if (phase==='in') t.hold > 0 ? setPhase('hold', t.hold) : setPhase('out', t.out);
  else if (phase==='hold') setPhase('out', t.out);
}

function startAmbientShift(){
  const stages = ['rgba(122,184,255,.04)','rgba(120,240,177,.05)','rgba(180,147,255,.04)','rgba(120,240,177,.06)'];
  let i = 0;
  ambientOverlay.style.opacity = '1';
  ambientOverlay.style.background = stages[0];
  return setInterval(() => {
    i = (i + 1) % stages.length;
    ambientOverlay.style.background = stages[i];
  }, 8000);
}
function stopAmbientShift(timer){
  clearInterval(timer);
  ambientOverlay.style.opacity = '0';
}

function startWaveform(){
  if (waveAnimId) return;
  const ctx = waveCanvas.getContext('2d');
  function draw(){
    const dpr = window.devicePixelRatio || 1;
    waveCanvas.width = waveCanvas.offsetWidth * dpr;
    waveCanvas.height = waveCanvas.offsetHeight * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const W = waveCanvas.offsetWidth;
    const H = waveCanvas.offsetHeight;
    ctx.clearRect(0,0,W,H);

    const t = getTimings();
    const breathCycle = t.in + t.hold + t.out;
    wavePhase += (2 * Math.PI) / (breathCycle * 60);

    ctx.beginPath();
    for (let x = 0; x <= W; x++){
      const angle = wavePhase + (x / W) * Math.PI * 4;
      const y = H/2 - Math.sin(angle) * (H/2 - 4);
      if (x === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    const grad = ctx.createLinearGradient(0,0,W,0);
    grad.addColorStop(0,'rgba(120,240,177,0)');
    grad.addColorStop(.3,'rgba(120,240,177,.5)');
    grad.addColorStop(.7,'rgba(122,184,255,.5)');
    grad.addColorStop(1,'rgba(122,184,255,0)');
    ctx.strokeStyle = grad;
    ctx.lineWidth = 1.5;
    ctx.stroke();

    waveAnimId = requestAnimationFrame(draw);
  }
  draw();
}
function stopWaveform(){
  if (waveAnimId){ cancelAnimationFrame(waveAnimId); waveAnimId = null; }
  const ctx = waveCanvas.getContext('2d');
  ctx.clearRect(0,0,waveCanvas.width,waveCanvas.height);
}

let ambientTimer = null;
function startBreath(){
  totalRemaining = Math.max(1, +durationMin.value) * 60;
  running = true;

  // fade field header (Orion)
  if (fieldHeader){
    fieldHeader.style.opacity = '0';
  }

  startBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 14 14" fill="currentColor"><rect x="3" y="3" width="8" height="8" rx="1"/></svg> Stop';
  startBtn.classList.add('running');

  advancePhase();
  startWaveform();
  ambientTimer = startAmbientShift();

  tick = setInterval(() => {
    totalRemaining--;
    timerPill.textContent = mmss(totalRemaining);
    phaseRemaining--;
    phaseCountdown.textContent = phaseRemaining > 0 ? phaseRemaining : '';
    if (phaseRemaining <= 0) advancePhase();
    if (totalRemaining <= 0) stopBreath(true);
  }, 1000);
}
function stopBreath(completed=false){
  running = false;
  clearInterval(tick); tick = null;

  phase = 'idle';
  circle.classList.remove('inhale','hold','exhale');
  phasePill.innerHTML = '<span class="dot"></span> Ready';
  phasePill.classList.remove('active');
  phaseText.textContent = 'Tap to begin';
  phaseCountdown.textContent = '·';
  timerPill.textContent = '00:00';

  // return header
  if (fieldHeader){
    fieldHeader.style.transition = 'opacity 0.8s ease';
    fieldHeader.style.opacity = '0.8';
  }

  startBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 14 14" fill="currentColor"><path d="M3 2l9 5-9 5V2z"/></svg> Start';
  startBtn.classList.remove('running');

  stopWaveform();
  stopAmbientShift(ambientTimer);

  if (completed) haptic(40);
}
startBtn.addEventListener('click', () => { running ? stopBreath() : startBreath(); haptic(12); });

/* CUES */
function randomCue(){
  const cur = cueLine.textContent;
  const opts = CUES.filter(c => c !== cur);
  return opts[Math.floor(Math.random()*opts.length)];
}
newCueBtn.addEventListener('click', () => {
  cueLine.classList.add('fade');
  setTimeout(() => { cueLine.textContent = randomCue(); cueLine.classList.remove('fade'); }, 150);
  haptic(6);
});

/* INIT */
function init(){
  applyTheme(localStorage.getItem(KEY.theme)==='light');
  paletteIdx = (+localStorage.getItem(KEY.color) || 0) % PALETTES.length;
  applyPalette(paletteIdx);

  buildPresets();
  presetSel.value = "0";
  applyPreset(0);
  setDuration(5);

  window.addEventListener('resize', () => {
    // waveform will self-scale on next frame; no extra work
  });
}
init();
})();
</script>
</body>
</html>
