<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coherence</title>

<style>
:root{
  --bg:#f6f8fb;
  --fg:#111;
  --card:#fff;
  --accent:#6ee7b7;
  --muted:#777;
}

body.dark{
  --bg:#0f172a;
  --fg:#e5e7eb;
  --card:#020617;
  --accent:#38bdf8;
  --muted:#94a3b8;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--fg);
}

.wrap{
  max-width:460px;
  margin:auto;
  padding:16px;
}

h1{
  margin:6px 0;
}

.card{
  background:var(--card);
  border-radius:18px;
  padding:16px;
  box-shadow:0 6px 20px rgba(0,0,0,.06);
  margin-bottom:16px;
}

.row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}

button,select,input{
  font-size:16px;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid #ccc;
  background:#fff;
}

body.dark button,
body.dark select,
body.dark input{
  background:#020617;
  color:var(--fg);
  border-color:#334155;
}

button.primary{
  background:#3b82f6;
  color:#fff;
  border:none;
}

.pill{
  padding:6px 12px;
  border-radius:999px;
  background:#eef2f7;
}

body.dark .pill{
  background:#020617;
}

.center{
  text-align:center;
}

/* Circle */

.circleWrap{
  position:relative;
  width:260px;
  height:260px;
  margin:auto;
}

#breathCircle{
  width:100%;
  height:100%;
  border-radius:50%;
  background:radial-gradient(circle,#9fffd0,var(--accent));
  transition:transform 1s linear;
  box-shadow:0 0 50px rgba(110,231,183,.5);
}

/* Ring */

svg{
  position:absolute;
  inset:0;
}

#scoreRing .ring-track{
  fill:none;
  stroke:rgba(120,240,177,.04);
  stroke-width:2;
}

#scoreRing .ring-fill{
  fill:none;
  stroke:var(--accent);
  stroke-width:2;
  opacity:.45;
  stroke-linecap:round;
  stroke-dasharray:565;
  stroke-dashoffset:565;
  transition:stroke-dashoffset 1s ease;
}

/* Log */

.log{
  background:#fafafa;
  padding:8px;
  border-radius:10px;
  margin:6px 0;
  font-size:14px;
}

body.dark .log{
  background:#020617;
}

/* Slider */

input[type=range]{
  width:100%;
}

.small{
  font-size:13px;
  color:var(--muted);
}

.explain{
  background:#e6fef0;
  padding:10px;
  border-radius:12px;
  font-size:14px;
}

body.dark .explain{
  background:#052e1a;
}
</style>
</head>

<body>

<div class="wrap">

<h1>Coherence</h1>
<div class="small">Reset ‚Ä¢ Steer ‚Ä¢ Reflect</div>

<!-- Circle -->

<div class="card center">

<div class="circleWrap">

<div id="breathCircle"></div>

<svg viewBox="0 0 200 200" id="scoreRing">
<circle class="ring-track" cx="100" cy="100" r="90"/>
<circle class="ring-fill" cx="100" cy="100" r="90"/>
</svg>

</div>

<div id="phaseTxt">Ready</div>

<div class="row center">
<span class="pill" id="timeTxt">00:00</span>
<span class="pill" id="fieldTxt">Field: ‚Äî</span>
</div>

</div>

<!-- Controls -->

<div class="card">

<label>Pattern</label><br>

<select id="patternSel">
<option value="calm">Calm (4‚Äì6)</option>
<option value="focus">Focus (4‚Äì4)</option>
<option value="coh">Coherence (5.5‚Äì5.5)</option>
<option value="sleep">Sleep (4‚Äì8)</option>
<option value="custom">Custom</option>
</select>

<div class="row">

<input id="inSec" type="number" value="4" min="1">
<input id="holdSec" type="number" value="0" min="0">
<input id="outSec" type="number" value="6" min="1">

</div>

<label>Minutes</label>
<input type="range" min="1" max="30" value="2" id="durSlider">

<div class="center">
<span id="durTxt">2 min</span>
</div>

<div class="explain" id="explainBox"></div>

</div>

<!-- Session -->

<div class="card">

<div class="row">

<button class="primary" id="startBtn">Start</button>
<button id="darkBtn">Dark</button>
<button id="cueBtn">New cue</button>

</div>

<div class="row">

<select id="toneSel">
<option value="off">Sound Off</option>
<option value="432">432 Hz</option>
<option value="528">528 Hz</option>
</select>

<button id="joinBtn">Join Field</button>
<button id="leaveBtn">Leave</button>
<span class="pill">üåê <span id="countTxt">0</span></span>

</div>

</div>

<!-- Gauge -->

<div class="card">

<label>Gauge</label>
<input type="range" min="-5" max="5" value="0" id="gauge">

<div>
<span id="gaugeVal">0</span>
<span id="gaugeLab">Neutral</span>
</div>

<textarea id="note" rows="3" placeholder="One line note..."></textarea>

<div class="row">
<button class="primary" id="logBtn">Log</button>
<button id="clearBtn">Clear</button>
</div>

<div id="logBox"></div>

</div>

</div>

<script>

/* CONFIG */

const WORKER = "https://coherence-presence-2.lucolly999.workers.dev";

/* DATA */

const cues=[
"Equanimity and awareness",
"Steady",
"Soft eyes",
"Gentle",
"Release",
"Tone first",
"Match this",
"Ease"
];

const patterns={
 calm:[4,0,6,"Longer exhale signals safety and supports vagal tone."],
 focus:[4,0,4,"Balanced rhythm supports focus and clarity."],
 coh:[5.5,0,5.5,"Gold standard HRV coherence pattern."],
 sleep:[4,0,8,"Extended exhale promotes parasympathetic settling."]
};

/* STATE */

let running=false;
let phase="in";
let timer=null;
let remain=0;
let uid=null;
let beat=null;

/* HELPERS */

const $=id=>document.getElementById(id);

function vibrate(ms=20){
 if(navigator.vibrate) navigator.vibrate(ms);
}

function fmt(s){
 const m=Math.floor(s/60);
 const r=s%60;
 return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");
}

/* CIRCLE */

const colors=["#6ee7b7","#38bdf8","#fbbf24","#f472b6","#c084fc"];
let col=0;

$("breathCircle").onclick=()=>{
 col=(col+1)%colors.length;
 document.documentElement.style.setProperty("--accent",colors[col]);
};

/* AUDIO */

let ctx=null,osc=null;

function tone(freq){
 if(freq==="off"){stopTone();return;}
 if(!ctx) ctx=new AudioContext();
 stopTone();
 osc=ctx.createOscillator();
 osc.frequency.value=freq;
 osc.connect(ctx.destination);
 osc.start();
}

function stopTone(){
 if(osc){osc.stop();osc=null;}
}

/* PATTERN */

function setPattern(p){
 if(p==="custom") return;

 const [i,h,o,txt]=patterns[p];

 $("inSec").value=i;
 $("holdSec").value=h;
 $("outSec").value=o;
 $("explainBox").textContent=txt;
}

$("patternSel").onchange=e=>{
 setPattern(e.target.value);
};

/* TIMER */

function tick(){
 remain--;
 $("timeTxt").textContent=fmt(remain);

 if(remain<=0){
  stop();
  return;
 }

 let dur=phase==="in"?+$("inSec").value:
         phase==="hold"?+$("holdSec").value:
         +$("outSec").value;

 setTimeout(nextPhase,dur*1000);
}

function nextPhase(){

 if(!running) return;

 if(phase==="in"){
  phase=$("holdSec").value>0?"hold":"out";
  $("breathCircle").style.transform="scale(1)";
 }
 else if(phase==="hold"){
  phase="out";
 }
 else{
  phase="in";
  $("breathCircle").style.transform="scale(1.15)";
 }

 $("phaseTxt").textContent=phase.toUpperCase();
 vibrate();

 let dur=phase==="in"?+$("inSec").value:
         phase==="hold"?+$("holdSec").value:
         +$("outSec").value;

 setTimeout(nextPhase,dur*1000);
}

/* START STOP */

function start(){

 if(running) return;

 running=true;

 remain=+$("durSlider").value*60;
 $("timeTxt").textContent=fmt(remain);

 phase="in";
 $("phaseTxt").textContent="IN";

 $("breathCircle").style.transform="scale(1.15)";

 timer=setInterval(tick,1000);

 nextPhase();

 tone($("toneSel").value);

 $("startBtn").textContent="Stop";
}

function stop(){

 running=false;

 clearInterval(timer);

 stopTone();

 $("breathCircle").style.transform="scale(1)";

 $("phaseTxt").textContent="Ready";

 $("startBtn").textContent="Start";
}

$("startBtn").onclick=()=>{
 running?stop():start();
};

/* DURATION */

$("durSlider").oninput=e=>{
 $("durTxt").textContent=e.target.value+" min";
};

/* DARK */

$("darkBtn").onclick=()=>{
 document.body.classList.toggle("dark");
};

/* CUE */

$("cueBtn").onclick=()=>{
 $("phaseTxt").textContent=cues[Math.floor(Math.random()*cues.length)];
};

/* GAUGE */

$("gauge").oninput=e=>{
 const v=+e.target.value;
 $("gaugeVal").textContent=v;

 $("gaugeLab").textContent=
  v<-2?"Tight":v>2?"Open":"Neutral";
};

/* LOG */

function load(){
 return JSON.parse(localStorage.getItem("cohlog")||"[]");
}

function save(x){
 localStorage.setItem("cohlog",JSON.stringify(x));
}

function renderLog(){

 const box=$("logBox");
 box.innerHTML="";

 load().forEach(l=>{
  const d=document.createElement("div");
  d.className="log";
  d.innerHTML=`<b>${new Date(l.t).toLocaleString()}</b><br>
  ${l.cue} (g ${l.g})<br>${l.n}`;
  box.prepend(d);
 });
}

$("logBtn").onclick=()=>{

 const l=load();

 l.push({
  t:Date.now(),
  cue:$("phaseTxt").textContent,
  g:$("gauge").value,
  n:$("note").value
 });

 save(l);
 renderLog();

 $("note").value="";
};

$("clearBtn").onclick=()=>{
 localStorage.removeItem("cohlog");
 renderLog();
};

/* FIELD */

async function api(p){
 const r=await fetch(WORKER+p);
 return r.json();
}

async function join(){

 const r=await api("/join");

 uid=r.id;

 $("fieldTxt").textContent="Field: joined";

 $("countTxt").textContent=r.count;

 beat=setInterval(async()=>{
  const h=await api("/heartbeat?id="+uid);
  $("countTxt").textContent=h.count;
 },30000);
}

async function leave(){

 if(!uid) return;

 const r=await api("/leave?id="+uid);

 $("countTxt").textContent=r.count;

 uid=null;

 clearInterval(beat);

 $("fieldTxt").textContent="Field: ‚Äî";
}

$("joinBtn").onclick=join;
$("leaveBtn").onclick=leave;

/* INIT */

setPattern("calm");
renderLog();

</script>

</body>
</html>
