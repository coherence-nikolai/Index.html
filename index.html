<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Coherence</title>
<meta name="theme-color" content="#8fb9ff">

<style>
body {
  font-family: -apple-system, system-ui, Arial;
  margin: 24px;
  max-width: 860px;
  background: #f5f7fb;
  transition: background .3s, color .3s;
}

body.dark {
  background: #111;
  color: #eee;
}

.card {
  background: white;
  padding: 16px;
  border-radius: 12px;
  border: 1px solid #ddd;
  margin: 12px 0;
}

body.dark .card {
  background: #1c1c1c;
  border-color: #333;
}

.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

button, select, input, textarea {
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 16px;
}

button { cursor: pointer; }

.big {
  font-size: 26px;
  font-weight: 700;
}

.pill {
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 999px;
}

#breathCircle {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  margin: 20px auto;
  transition: transform linear, background .4s;
  box-shadow: 0 0 25px rgba(120,160,255,0.4);
  cursor: pointer;
}

.logs {
  max-height: 220px;
  overflow-y: auto;
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 8px;
  background: #fafafa;
  font-size: 14px;
}

body.dark .logs {
  background: #222;
  border-color: #444;
}
</style>
</head>

<body>

<h1>Coherence</h1>
<div>Reset ‚Ä¢ Steer ‚Ä¢ Reflect</div>

<div class="card">

<div id="breathCircle"></div>

<!-- Controls -->
<div class="row">

<select id="preset">
  <option value="calm">Calm (4‚Äì6)</option>
  <option value="focus">Focus (4‚Äì4)</option>
  <option value="sleep">Sleep (4‚Äì8)</option>
  <option value="energise">Energise (6‚Äì2)</option>
  <option value="custom">Custom</option>
</select>

<input id="inSec" type="number" value="4" style="width:70px;">
<input id="outSec" type="number" value="6" style="width:70px;">

<select id="duration">
  <option value="1">1m</option>
  <option value="3">3m</option>
  <option value="5" selected>5m</option>
  <option value="10">10m</option>
</select>

</div>

<div class="row" style="margin-top:12px;">

<button id="startStop">Start</button>

<span class="pill" id="phase">Ready</span>
<span class="pill" id="timer">05:00</span>

</div>

<!-- Cue -->
<div class="big" id="cue" style="margin-top:15px;">
Equanimity and awareness
</div>

<div class="row" style="margin-top:10px;">
<button id="newCue">New cue</button>
<button id="darkToggle">Dark</button>
</div>

<hr>

<!-- Gauge -->
<label>Gauge</label>
<input id="gauge" type="range" min="-5" max="5" value="0">

<div class="row">
<span id="gaugeVal">0</span>
<span id="gaugeLabel">Neutral</span>
</div>

<textarea id="note" rows="2" placeholder="One line note..."></textarea>

<div class="row">
<button id="saveLog">Log</button>
<button id="clearLogs">Clear</button>
</div>

<div class="logs" id="logsBox"></div>

<hr>

<!-- Presence -->
<div>
üåê Shared Field:
<strong id="presenceCount">‚Äî</strong>
</div>

</div>


<script>

/* CONFIG */

const PRESENCE_BASE =
"https://coherence-presence-2.lucolly999.workers.dev";

const LOG_KEY = "coh_logs_v3";


/* STATE */

let running=false;
let startTime=0;
let breathTimer=null;
let tick=null;
let phase="Ready";
let sessionSec=300;
let presenceId=null;
let colorIndex=0;


/* CUES */

const CUES = [
  "Equanimity and awareness",
  "Steady",
  "Soft eyes",
  "Release",
  "Match this",
  "Joy",
  "Metta"
];


/* CIRCLE COLOURS */

const COLORS = [
  "radial-gradient(circle at 30% 30%, #a9c7ff, #6fa0ff)",
  "radial-gradient(circle at 30% 30%, #a8ffd6, #4ccf99)",
  "radial-gradient(circle at 30% 30%, #ffd6a8, #ff9f4c)",
  "radial-gradient(circle at 30% 30%, #e0b3ff, #9c6cff)",
  "radial-gradient(circle at 30% 30%, #ffb3c6, #ff5f87)"
];


/* UTIL */

function mmss(s){
  const m=Math.floor(s/60);
  const r=s%60;
  return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");
}

function haptic(ms=15){
  if(navigator.vibrate){
    navigator.vibrate(ms);
  }
}

function gaugeText(v){
  if(v<-2) return "Tight";
  if(v>2) return "Open";
  return "Neutral";
}


/* LOGS */

function loadLogs(){
  try{
    return JSON.parse(localStorage.getItem(LOG_KEY))||[];
  }catch{
    return [];
  }
}

function saveLogs(l){
  localStorage.setItem(LOG_KEY,JSON.stringify(l));
}

function renderLogs(){
  const box=logsBox;
  const logs=loadLogs().slice().reverse();

  if(!logs.length){
    box.innerHTML="<em>No logs yet</em>";
    return;
  }

  box.innerHTML=logs.map(e=>`
    <div style="margin-bottom:6px;">
      <strong>${e.cue}</strong> (${e.g})<br>
      <span>${e.n||""}</span>
    </div>
  `).join("");
}


/* PRESENCE */

function updatePresence(){
  fetch(PRESENCE_BASE+"/presence/count")
  .then(r=>r.json())
  .then(j=>{
    presenceCount.textContent=j.count;
  }).catch(()=>{});
}

function joinPresence(){
  fetch(PRESENCE_BASE+"/presence/join")
  .then(r=>r.json())
  .then(j=>{
    presenceId=j.id;
    updatePresence();
  });
}

function leavePresence(){
  if(!presenceId) return;
  navigator.sendBeacon(
    PRESENCE_BASE+"/presence/leave?id="+presenceId
  );
}


/* BREATHING */

function scheduleBreath(){

  const inSec=+inSec.value;
  const outSec=+outSec.value;
  const circle=breathCircle;

  if(phase==="Ready"||phase==="Out"){

    phase="In";
    phaseEl.textContent="Inhale";

    circle.style.transition=
      `transform ${inSec}s linear`;

    circle.style.transform="scale(1.4)";

    haptic(15);

    breathTimer=setTimeout(
      scheduleBreath,inSec*1000
    );

  }else{

    phase="Out";
    phaseEl.textContent="Exhale";

    circle.style.transition=
      `transform ${outSec}s linear`;

    circle.style.transform="scale(1)";

    haptic(30);

    breathTimer=setTimeout(
      scheduleBreath,outSec*1000
    );
  }
}


/* SESSION */

function start(){

  if(running) return;

  running=true;
  startTime=Date.now();

  sessionSec=+duration.value*60;

  scheduleBreath();

  tick=setInterval(()=>{

    const elapsed=
      Math.floor((Date.now()-startTime)/1000);

    const remain=
      Math.max(0,sessionSec-elapsed);

    timer.textContent=mmss(remain);

    if(remain<=0){
      stop();
      bell();
    }

  },500);
}

function stop(){

  running=false;

  clearTimeout(breathTimer);
  clearInterval(tick);

  phase="Ready";
  phaseEl.textContent="Ready";

  breathCircle.style.transform="scale(1)";
}


/* BELL */

function bell(){

  const ctx=new (window.AudioContext||
    window.webkitAudioContext)();

  const o=ctx.createOscillator();
  const g=ctx.createGain();

  o.frequency.value=432;
  o.connect(g);
  g.connect(ctx.destination);

  o.start();

  g.gain.exponentialRampToValueAtTime(
    0.0001,ctx.currentTime+1
  );

  o.stop(ctx.currentTime+1);
}


/* UI */

startStop.onclick=()=>{
  running?stop():start();
};

newCue.onclick=()=>{
  cue.textContent=
    CUES[Math.floor(Math.random()*CUES.length)];
};

preset.onchange=e=>{
  const v=e.target.value;

  if(v==="calm"){inSec.value=4;outSec.value=6;}
  if(v==="focus"){inSec.value=4;outSec.value=4;}
  if(v==="sleep"){inSec.value=4;outSec.value=8;}
  if(v==="energise"){inSec.value=6;outSec.value=2;}
};

darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
};

gauge.oninput=e=>{
  gaugeVal.textContent=e.target.value;
  gaugeLabel.textContent=gaugeText(+e.target.value);
};

saveLog.onclick=()=>{

  const l=loadLogs();

  l.push({
    t:new Date().toISOString(),
    cue:cue.textContent,
    g:gauge.value,
    n:note.value
  });

  saveLogs(l);
  note.value="";
  renderLogs();
};

clearLogs.onclick=()=>{
  localStorage.removeItem(LOG_KEY);
  renderLogs();
};


/* CIRCLE COLOUR */

breathCircle.onclick=()=>{

  colorIndex=(colorIndex+1)%COLORS.length;

  breathCircle.style.background=
    COLORS[colorIndex];
};


/* STARTUP */

breathCircle.style.background=COLORS[0];

renderLogs();
joinPresence();
updatePresence();

setInterval(updatePresence,10000);

window.addEventListener("beforeunload",leavePresence);

</script>
</body>
</html>
